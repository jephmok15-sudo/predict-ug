<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Admin — Predict UG</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;600;800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body{margin:0;font-family:'Poppins',sans-serif;background:#020202;color:#fff}
    header{padding:18px 16px;text-align:center;border-bottom:1px solid #0a0a0a}
    header h1{margin:0;color:#b91d1d}
    .wrap{max-width:1200px;margin:18px auto;padding:0 16px}
    .grid{display:grid;grid-template-columns:1fr 420px;gap:18px}
    @media(max-width:980px){.grid{grid-template-columns:1fr}}
    .card{background:#101010;padding:14px;border-radius:12px;border:1px solid #151515;margin-bottom:14px}
    label{display:block;color:#9aa0a6;font-size:13px;margin-bottom:6px}
    input,textarea,select{width:100%;padding:10px;border-radius:8px;background:#070707;border:1px solid #232323;color:#fff}
    button{padding:10px 12px;border-radius:10px;background:#b91d1d;color:#fff;border:0;font-weight:700}
    .small{font-size:13px;color:#9aa0a6}
    table{width:100%;border-collapse:collapse;margin-top:8px}
    td,th{padding:8px;border-bottom:1px solid #151515;font-size:14px}
    .danger{background:#6b0f0f}
    .success{background:#0b6b2b}
  </style>
</head>
<body>
  <header><h1>Predict UG — Admin Panel</h1><p class="small">Only for admins. Keep this URL private.</p></header>

  <div class="wrap">

    <!-- LOGIN -->
    <div class="card" id="loginCard">
      <h3>Admin Sign In</h3>
      <label>Email</label><input id="adminEmail" type="email" placeholder="admin@example.com">
      <label>Password</label><input id="adminPass" type="password" placeholder="password">
      <div style="margin-top:8px"><button id="btnLogin">Sign in</button></div>
      <p id="loginMsg" class="small"></p>
      <p class="small" style="margin-top:8px">Use Firebase Authentication. Create admin user via Firebase console first.</p>
    </div>

    <div class="grid">

      <main>
        <!-- ADD / APPROVE PREDICTIONS -->
        <div class="card">
          <h3>Add / Approve Predictions</h3>
          <label>Match / Event</label><input id="matchInput" placeholder="Arsenal vs Chelsea">
          <label>Odds</label><input id="oddsInput" placeholder="1.85">
          <label>Details</label><textarea id="detailsInput" rows="3" placeholder="Prediction details..."></textarea>
          <label>Affiliate link (optional) — will be normalized to BetPawa if missing</label><input id="affInput" placeholder="your-ref-or-full-url">
          <div style="display:flex;gap:8px;margin-top:8px">
            <button id="btnAdd">Add & Publish</button>
            <button id="btnAddDraft" style="background:#444">Add Draft</button>
          </div>
          <p class="small" style="margin-top:8px">Published items set <strong>approved=true</strong> and show on public site.</p>
        </div>

        <div class="card">
          <h3>Published Predictions</h3>
          <div id="publishedList">Loading published predictions...</div>
        </div>

        <div class="card">
          <h3>Draft / Pending</h3>
          <div id="pendingList">Loading pending items...</div>
        </div>
      </main>

      <aside>
        <div class="card">
          <h3>Ads & Affiliate</h3>
          <label>Affiliate Name</label><input id="adName" placeholder="BetPawa Partner">
          <label>Affiliate Link (ref or path)</label><input id="adLink" placeholder="your-ref-or-path">
          <label>Top Ad HTML (raw HTML allowed)</label><textarea id="adHtml" rows="4" placeholder="<div>Custom ad</div>"></textarea>
          <div style="display:flex;gap:8px;margin-top:8px">
            <button id="saveAds">Save Ads</button>
            <button id="clearAds" style="background:#444">Clear</button>
          </div>
          <p class="small" style="margin-top:8px">Links are normalized to start with BetPawa pattern.</p>
        </div>

        <div class="card">
          <h3>Payments / Account</h3>
          <label>Record Payment (user phone/name)</label><input id="payUser" placeholder="0701234567 or Name">
          <label>Amount (UGX)</label><input id="payAmount" type="number" placeholder="5000">
          <label>Method</label><select id="payMethod"><option>MTN</option><option>Airtel</option><option>Card</option></select>
          <div style="margin-top:8px"><button id="recordPay">Record Payment</button></div>

          <h4 style="margin-top:12px">Account Balance (Admin)</h4>
          <p class="small">This is your admin ledger where recorded payments increase 'adminAccount' balance in UGX.</p>
          <div style="display:flex;gap:8px;margin-top:8px">
            <button id="withdrawBtn" style="background:#444">Withdraw UGX</button>
          </div>

          <div id="accountInfo" style="margin-top:10px;color:#9aa0a6">Loading account...</div>
        </div>

        <div class="card">
          <h3>VIP Control</h3>
          <label>VIP Price (UGX)</label><input id="vipPrice" placeholder="5000">
          <label>VIP Enabled?</label><select id="vipEnabled"><option value="true">Yes</option><option value="false">No</option></select>
          <div style="margin-top:8px"><button id="saveVip">Save VIP</button></div>
        </div>

        <div class="card">
          <h3>Analytics (Live)</h3>
          <canvas id="adminChart" width="320" height="160"></canvas>
          <p class="small" style="margin-top:8px">Visitors & conversions chart (data from analytics node).</p>
        </div>

      </aside>
    </div>

    <!-- payments table -->
    <div class="card">
      <h3>Payments Ledger</h3>
      <div id="paymentsTable">Loading...</div>
    </div>

    <div class="card">
      <h3>Earnings Board</h3>
      <div id="earningsBoard">Loading earnings...</div>
    </div>

  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

  <script>
    // ---------- CONFIG ----------
    const firebaseConfig = {
      apiKey: "AIzaSyBnIeC8g8sx0KxKgoHQNqRlT3u3EVYA_10",
      authDomain: "predict-ug.firebaseapp.com",
      databaseURL: "https://predict-ug-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "predict-ug",
      storageBucket: "predict-ug.firebasestorage.app",
      messagingSenderId: "904307610384",
      appId: "1:904307610384:web:588965a0949648ff89cb95"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    // refs
    const predictionsRef = db.ref('predictions');
    const adsRef = db.ref('adsAffiliate');
    const paymentsRef = db.ref('payments');
    const earningsRef = db.ref('earnings');
    const adminAccountRef = db.ref('adminAccount');
    const analyticsRef = db.ref('analytics');
    const statsRef = db.ref('stats');

    // elements
    const loginCard = document.getElementById('loginCard');
    const adminEmail = document.getElementById('adminEmail');
    const adminPass = document.getElementById('adminPass');
    const btnLogin = document.getElementById('btnLogin');
    const loginMsg = document.getElementById('loginMsg');

    const matchInput = document.getElementById('matchInput');
    const oddsInput = document.getElementById('oddsInput');
    const detailsInput = document.getElementById('detailsInput');
    const affInput = document.getElementById('affInput');
    const btnAdd = document.getElementById('btnAdd');
    const btnAddDraft = document.getElementById('btnAddDraft');

    const publishedList = document.getElementById('publishedList');
    const pendingList = document.getElementById('pendingList');

    const adName = document.getElementById('adName');
    const adLink = document.getElementById('adLink');
    const adHtml = document.getElementById('adHtml');
    const saveAds = document.getElementById('saveAds');
    const clearAds = document.getElementById('clearAds');

    const payUser = document.getElementById('payUser');
    const payAmount = document.getElementById('payAmount');
    const payMethod = document.getElementById('payMethod');
    const recordPay = document.getElementById('recordPay');
    const accountInfo = document.getElementById('accountInfo');
    const withdrawBtn = document.getElementById('withdrawBtn');

    const vipPrice = document.getElementById('vipPrice');
    const vipEnabled = document.getElementById('vipEnabled');
    const saveVip = document.getElementById('saveVip');

    const paymentsTable = document.getElementById('paymentsTable');
    const earningsBoard = document.getElementById('earningsBoard');

    // admin chart
    const adminChart = new Chart(document.getElementById('adminChart').getContext('2d'), {
      type:'bar',
      data:{labels:[],datasets:[{label:'Visitors',backgroundColor:'#b91d1d',data:[]},{label:'Conversions',backgroundColor:'#0b6b2b',data:[]}]},
      options:{responsive:true,maintainAspectRatio:false}
    });

    // helper to ensure betpawa prefix
    function normalizeLink(raw){
      if(!raw) return '';
      if(raw.includes('betpawa')) return raw;
      return 'https://www.betpawa.ug/' + String(raw).replace(/^\/+/,'');
    }

    // ------- Auth & admin gating -------
    btnLogin.addEventListener('click', ()=>{
      const email = adminEmail.value.trim();
      const pass = adminPass.value;
      if(!email||!pass) { loginMsg.innerText = 'Enter credentials'; return; }
      auth.signInWithEmailAndPassword(email, pass)
        .then(()=> loginMsg.innerText = 'Signed in')
        .catch(e=> loginMsg.innerText = 'Error: ' + e.message);
    });

    auth.onAuthStateChanged(user=>{
      if(user){
        loginCard.style.display = 'none';
        initializeAdminUI();
      } else {
        loginCard.style.display = '';
      }
    });

    // initialize admin UI after sign in
    function initializeAdminUI(){
      loadPublished();
      loadPending();
      loadAds();
      loadPayments();
      loadEarnings();
      loadAccount();
      loadVIP();
      loadAnalytics();
      statsRef.child('totalPoints').on('value', s=>{/* keep in DB; not shown here */});
    }

    // ------- add prediction -------
    btnAdd.addEventListener('click', ()=> addPrediction(true));
    btnAddDraft.addEventListener('click', ()=> addPrediction(false));
    function addPrediction(approved){
      const match = matchInput.value.trim();
      const odds = oddsInput.value.trim();
      const details = detailsInput.value.trim();
      let affiliateLink = affInput.value.trim();
      if(!match || !odds) return alert('Match and odds required');
      affiliateLink = normalizeLink(affiliateLink);
      const obj = { match, odds, details, affiliateLink, approved: !!approved, created: Date.now() };
      predictionsRef.push(obj).then(()=> {
        matchInput.value='';oddsInput.value='';detailsInput.value='';affInput.value='';
        loadPublished(); loadPending();
      });
    }

    // ------- load published & pending -------
    function loadPublished(){
      publishedList.innerHTML = 'Loading...';
      predictionsRef.orderByChild('approved').equalTo(true).on('value', snap=>{
        const data = snap.val() || {};
        publishedList.innerHTML = '';
        Object.entries(data).reverse().forEach(([id,item])=>{
          const div = document.createElement('div');
          div.style.marginBottom='8px';
          div.innerHTML = `<strong>${item.match}</strong> <div style="color:#9aa0a6">${item.odds} • ${item.details || ''}</div>
            <div style="margin-top:6px"><button onclick="unpublish('${id}')">Unpublish</button> <button onclick="deletePred('${id}')">Delete</button></div>`;
          publishedList.appendChild(div);
        });
      });
    }
    function loadPending(){
      pendingList.innerHTML = 'Loading...';
      predictionsRef.orderByChild('approved').equalTo(false).on('value', snap=>{
        const data = snap.val() || {};
        pendingList.innerHTML = '';
        Object.entries(data).reverse().forEach(([id,item])=>{
          const div = document.createElement('div');
          div.style.marginBottom='8px';
          div.innerHTML = `<strong>${item.match}</strong> <div style="color:#9aa0a6">${item.odds} • ${item.details || ''}</div>
            <div style="margin-top:6px"><button onclick="approve('${id}')">Approve</button> <button onclick="deletePred('${id}')">Delete</button></div>`;
          pendingList.appendChild(div);
        });
      });
    }

    window.approve = function(id){
      predictionsRef.child(id).update({ approved:true }).then(()=>{ loadPublished(); loadPending(); });
    };
    window.unpublish = function(id){
      predictionsRef.child(id).update({ approved:false }).then(()=>{ loadPublished(); loadPending(); });
    };
    window.deletePred = function(id){
      if(!confirm('Delete this prediction?')) return;
      predictionsRef.child(id).remove().then(()=>{ loadPublished(); loadPending(); });
    };

    // ------- Ads save -------
    saveAds.addEventListener('click', ()=>{
      const name = adName.value.trim();
      const link = normalizeLink(adLink.value.trim());
      const html = adHtml.value.trim();
      adsRef.set({ affiliateName: name, affiliateLink: link, topAdHtml: html }).then(()=> alert('Saved'));
    });
    clearAds.addEventListener('click', ()=>{ adsRef.remove(); adName.value=''; adLink.value=''; adHtml.value=''; });

    function loadAds(){
      adsRef.once('value').then(s=> {
        const v = s.val() || {};
        adName.value = v.affiliateName || '';
        adLink.value = v.affiliateLink || '';
        adHtml.value = v.topAdHtml || '';
      });
    }

    // ------- payments & account -------
    recordPay.addEventListener('click', ()=>{
      const who = payUser.value.trim();
      const amt = Number(payAmount.value) || 0;
      const method = payMethod.value;
      if(!who || !amt) return alert('Please fill user and amount');
      const rec = { user: who, amount_ugx: amt, method, createdAt: Date.now(), adminRecorded: true };
      paymentsRef.push(rec).then(()=>{
        // credit admin account as earnings
        adminAccountRef.child('balance').transaction(curr => (Number(curr)||0) + amt);
        // record in earnings ledger
        earningsRef.push({ amount_ugx: amt, createdAt: Date.now(), note: 'Manual deposit: ' + who });
        payUser.value=''; payAmount.value=''; loadPayments(); loadAccount(); loadEarnings();
      });
    });

    function loadPayments(){
      paymentsRef.on('value', s=>{
        const v = s.val() || {};
        const rows = Object.entries(v).map(([id, r])=> ({id,...r})).reverse();
        paymentsTable.innerHTML = `<table><tr><th>User</th><th>Amount (UGX)</th><th>Method</th><th>When</th></tr>${rows.map(r=>`<tr><td>${escapeHtml(r.user)}</td><td>UGX ${Number(r.amount_ugx).toLocaleString()}</td><td>${r.method}</td><td>${new Date(r.createdAt).toLocaleString()}</td></tr>`).join('')}</table>`;
      });
    }

    // admin account info & withdraw
    function loadAccount(){
      adminAccountRef.on('value', s=>{
        const v = s.val() || { balance:0 };
        accountInfo.innerHTML = `<div style="font-weight:700">Balance: UGX ${(Number(v.balance)||0).toLocaleString()}</div><div class="small">Withdrawals recorded in ledger</div>`;
      });
    }

    withdrawBtn.addEventListener('click', ()=>{
      const amt = prompt('Enter withdraw amount (UGX)');
      const a = Number(amt)||0;
      if(!a) return;
      // subtract amount
      adminAccountRef.child('balance').transaction(curr => {
        curr = Number(curr)||0;
        if(curr < a){ alert('Insufficient balance'); return; }
        return curr - a;
      }).then(()=>{
        // record withdrawal in earnings ledger with negative amount
        earningsRef.push({ amount_ugx: -a, createdAt: Date.now(), note: 'Admin withdraw' });
        alert('Withdraw recorded');
      });
    });

    // earnings board
    function loadEarnings(){
      earningsRef.on('value', s=>{
        const v = s.val() || {};
        const rows = Object.entries(v).map(([id,r])=> ({id,...r})).reverse();
        earningsBoard.innerHTML = `<table><tr><th>Amount (UGX)</th><th>Note</th><th>When</th></tr>${rows.map(r=>`<tr><td>UGX ${Number(r.amount_ugx).toLocaleString()}</td><td>${escapeHtml(r.note||'')}</td><td>${new Date(r.createdAt).toLocaleString()}</td></tr>`).join('')}</table>`;
      });
    }

    // VIP config
    saveVip.addEventListener('click', ()=>{
      const price = Number(vipPrice.value)||0;
      const enabled = vipEnabled.value === 'true';
      db.ref('settings/vip').set({ price, enabled }).then(()=> alert('VIP saved'));
    });
    function loadVIP(){ db.ref('settings/vip').once('value').then(s=>{ const v=s.val()||{}; vipPrice.value = v.price||0; vipEnabled.value = (v.enabled?'true':'false'); }); }

    // admin analytics
    function loadAnalytics(){
      analyticsRef.on('value', s=>{
        const v = s.val() || {};
        const labels = Object.keys(v).sort();
        const visitors = labels.map(k=> v[k].visitors||0);
        const conv = labels.map(k=> v[k].conversions||0);
        adminChart.data.labels = labels;
        adminChart.data.datasets[0].data = visitors;
        adminChart.data.datasets[1].data = conv;
        adminChart.update();
      });
    }

    // utility
    function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

  </script>
</body>
</html>
