<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>PREDICT UG — Tips & Predictions (UGX)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <!-- fonts & chart lib -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;500;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    /* Dull Netflix-like theme (dark, muted) */
    :root{--bg:#040404;--card:#0f0f0f;--muted:#9aa0a6;--accent:#b91d1d;--gold:#c9a600}
    *{box-sizing:border-box}
    body{margin:0;font-family:'Poppins',system-ui,Arial;background:var(--bg);color:#fff;-webkit-font-smoothing:antialiased}
    header{padding:28px 16px;text-align:center;border-bottom:1px solid #0a0a0a}
    header h1{margin:0;color:var(--accent);letter-spacing:2px}
    header p{margin:6px 0 0;color:var(--muted);font-size:14px}
    .container{max-width:1100px;margin:22px auto;padding:0 16px}
    .card{background:var(--card);border-radius:12px;padding:16px;margin-bottom:18px;border:1px solid #121212}
    .top-grid{display:grid;grid-template-columns:1fr 320px;gap:16px}
    @media(max-width:920px){.top-grid{grid-template-columns:1fr;}}
    .search{display:flex;gap:8px}
    input.searchbox{flex:1;padding:12px 14px;border-radius:12px;border:1px solid #232323;background:#0a0a0a;color:#fff}
    .btn{background:var(--accent);color:#fff;padding:10px 12px;border-radius:10px;text-decoration:none;display:inline-block;font-weight:600}
    .prediction{padding:12px;border-radius:10px;background:#0b0b0b;margin-bottom:10px;border-left:4px solid #222}
    .prediction h3{margin:0;color:var(--gold);font-size:18px}
    .prediction p{margin:6px 0 0;color:var(--muted)}
    .odds{display:inline-block;margin-top:8px;padding:6px 10px;border-radius:8px;background:#111;border:1px solid #333}
    .stats-row{display:flex;gap:8px;flex-wrap:wrap}
    .stat{flex:1;min-width:140px;padding:12px;border-radius:10px;background:#0b0b0b;text-align:center}
    .stat h4{margin:0;color:var(--muted);font-weight:500}
    .stat strong{display:block;margin-top:6px;color:#fff;font-size:18px}
    footer{padding:22px;text-align:center;color:var(--muted);font-size:13px}
    .affiliate-btn{display:inline-block;background:#0b5c2c;padding:8px 12px;border-radius:8px;color:#fff;text-decoration:none}
    .vip-badge{padding:8px;border-radius:8px; background:linear-gradient(90deg,#3b2b6f,#b91d1d); color:#fff; display:inline-block}
    canvas{max-width:100%}
  </style>
</head>
<body>
  <header>
    <h1>PREDICT UG</h1>
    <p>Tips & predictions — We do not take or hold bets. Prices shown in UGX.</p>
  </header>

  <div class="container">

    <!-- Top area: ad + stats -->
    <div class="top-grid">
      <div>
        <div class="card" id="topAdCard">Loading partner ad...</div>

        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <h2 style="margin:0">Latest Predictions</h2>
            <div class="vip-badge">VIP Available</div>
          </div>

          <!-- search -->
          <div style="margin-top:12px" class="search">
            <input id="searchInput" class="searchbox" placeholder="Search team or match (e.g. Arsenal, Real Madrid)">
            <a id="clearSearch" class="btn" href="#" style="background:#333">Clear</a>
          </div>

          <div id="predictionsList" style="margin-top:14px">
            <div style="color:#9aa0a6">Loading predictions from admin panel...</div>
          </div>
        </div>

        <div class="card" id="supportCard" style="margin-top:16px">
          <h3 style="margin:0 0 8px 0">Support / Payment (UGX)</h3>
          <p style="color:var(--muted);margin:0 0 8px 0">Support us or buy VIP access. After payment contact admin.</p>
          <p style="margin:6px 0"><strong>Airtel Money:</strong> 0704557858 / 0752511141</p>
          <p style="margin:6px 0"><strong>MTN Mobile Money:</strong> 0765206538</p>
          <p style="margin:6px 0;color:var(--muted)">For card payments contact admin for a secure invoice.</p>
          <a href="mailto:predictug@gmail.com" class="btn">Contact Admin</a>
        </div>
      </div>

      <!-- Right column: stats + analytics -->
      <aside>
        <div class="card">
          <h3 style="margin-top:0">Platform Stats (live)</h3>
          <div class="stats-row" style="margin-top:10px">
            <div class="stat"><h4>Total Predictions</h4><strong id="totalPred">0</strong></div>
            <div class="stat"><h4>Total Points</h4><strong id="totalPoints">0</strong></div>
            <div class="stat"><h4>Users</h4><strong id="totalUsers">—</strong></div>
          </div>
        </div>

        <div class="card">
          <h3 style="margin-top:0">Earnings (UGX)</h3>
          <strong id="earningsTotal" style="font-size:20px">UGX 0</strong>
          <div style="margin-top:12px">
            <canvas id="earnChart" width="320" height="180"></canvas>
          </div>
        </div>

        <div class="card">
          <h3 style="margin-top:0">Affiliate</h3>
          <div id="affiliateBox">Loading affiliate partner...</div>
        </div>
      </aside>
    </div>

  </div>

  <footer>
    Predict UG © 2025 — We provide analysis & tips only. Always bet responsibly. Affiliate links start with BetPawa pattern.
  </footer>

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

  <script>
  /* ---------- CONFIG: replace with your Firebase config (or paste exact one) ---------- */
  const firebaseConfig = {
    apiKey: "AIzaSyBnIeC8g8sx0KxKgoHQNqRlT3u3EVYA_10",
    authDomain: "predict-ug.firebaseapp.com",
    databaseURL: "https://predict-ug-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "predict-ug",
    storageBucket: "predict-ug.firebasestorage.app",
    messagingSenderId: "904307610384",
    appId: "1:904307610384:web:588965a0949648ff89cb95"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  // refs
  const predictionsRef = db.ref('predictions');
  const adsRef = db.ref('adsAffiliate');
  const statsRef = db.ref('stats');
  const earningsRef = db.ref('earnings'); // earnings ledger
  const usersRef = db.ref('users');

  // UI refs
  const predictionsList = document.getElementById('predictionsList');
  const topAdCard = document.getElementById('topAdCard');
  const affiliateBox = document.getElementById('affiliateBox');
  const totalPred = document.getElementById('totalPred');
  const totalPoints = document.getElementById('totalPoints');
  const totalUsers = document.getElementById('totalUsers');
  const earningsTotal = document.getElementById('earningsTotal');

  // charts
  const earnCtx = document.getElementById('earnChart').getContext('2d');
  let earningsChart = new Chart(earnCtx, { type:'line', data:{ labels:[], datasets:[{label:'UGX',borderColor:'#c9a600',backgroundColor:'rgba(201,166,0,0.12)',data:[]}]}, options:{responsive:true,maintainAspectRatio:false}});

  // helper: ensure BetPawa prefix for links
  function normalizeAffiliateLink(raw){
    if(!raw) return '';
    // If user provided a full URL that contains betpawa domain accept it; else prefix to betpawa pattern
    if(raw.includes('betpawa')) return raw;
    // ensure http://
    let base = 'https://www.betpawa.ug/';
    // strip leading slashes
    raw = String(raw).replace(/^\/+/, '');
    return base + raw;
  }

  // load ads / affiliate
  adsRef.on('value', snap=>{
    const d = snap.val();
    if(!d){
      topAdCard.innerHTML = '<div style="color:#9aa0a6">No ad set in admin panel</div>';
      affiliateBox.innerHTML = '<div style="color:#9aa0a6">No affiliate</div>';
      return;
    }
    if(d.topAdHtml && d.topAdHtml.length>8){
      topAdCard.innerHTML = d.topAdHtml;
    } else {
      // show affiliate button; ensure BetPawa pattern
      const link = normalizeAffiliateLink(d.affiliateLink || '#');
      topAdCard.innerHTML = `<div style="text-align:center"><h3 style="color:#fff;margin:0">${d.affiliateName || 'Partner'}</h3><a class="affiliate-btn" href="${link}" target="_blank">Open Partner on BetPawa</a></div>`;
    }
    // sidebar affiliate box
    affiliateBox.innerHTML = `<div><strong style="display:block">${d.affiliateName || 'Partner'}</strong><p style="color:#9aa0a6;margin:6px 0">${d.affiliateDesc || ''}</p><a class="affiliate-btn" href="${normalizeAffiliateLink(d.affiliateLink||'#')}" target="_blank">Go to BetPawa</a></div>`;
  });

  // load predictions (approved only)
  predictionsRef.orderByChild('approved').equalTo(true).on('value', snap=>{
    const data = snap.val();
    predictionsList.innerHTML = '';
    window._allPredictions = [];
    if(!data){
      predictionsList.innerHTML = '<div style="color:#9aa0a6">No approved predictions yet</div>';
      totalPred.innerText = '0';
      return;
    }
    const list = Object.entries(data).map(([k,v]) => ({id:k,...v})).sort((a,b)=> (b.created||0)-(a.created||0));
    window._allPredictions = list;
    totalPred.innerText = list.length;
    list.forEach(item=>{
      const el = document.createElement('div');
      el.className = 'prediction';
      const affiliateHTML = item.affiliateLink ? `<a class="btn" href="${normalizeAffiliateLink(item.affiliateLink)}" target="_blank">Open on BetPawa</a>` : '';
      el.innerHTML = `<h3>${escapeHtml(item.match)}</h3><div class="odds">Odds: ${escapeHtml(item.odds)}</div><p>${escapeHtml(item.details)}</p>${affiliateHTML}`;
      predictionsList.appendChild(el);
    });
  });

  // search
  document.getElementById('searchInput').addEventListener('input', e=>{
    const q = String(e.target.value || '').toLowerCase().trim();
    const arr = (window._allPredictions || []).filter(it => (it.match||'').toLowerCase().includes(q) || (it.details||'').toLowerCase().includes(q));
    predictionsList.innerHTML = '';
    if(arr.length===0){ predictionsList.innerHTML = '<div style="color:#9aa0a6">No match found</div>'; return; }
    arr.forEach(item=>{
      const el = document.createElement('div'); el.className='prediction';
      const affiliateHTML = item.affiliateLink ? `<a class="btn" href="${normalizeAffiliateLink(item.affiliateLink)}" target="_blank">Open on BetPawa</a>` : '';
      el.innerHTML = `<h3>${escapeHtml(item.match)}</h3><div class="odds">Odds: ${escapeHtml(item.odds)}</div><p>${escapeHtml(item.details)}</p>${affiliateHTML}`;
      predictionsList.appendChild(el);
    });
  });
  document.getElementById('clearSearch').addEventListener('click', e=>{ e.preventDefault(); document.getElementById('searchInput').value=''; document.getElementById('searchInput').dispatchEvent(new Event('input')); });

  // load stats: points (from stats/totalPoints), users count, earnings (from earnings ledger)
  statsRef.child('totalPoints').on('value', s=> totalPoints.innerText = s.val()||0);
  usersRef.on('value', s=> totalUsers.innerText = (s.val()? Object.keys(s.val()).length : 0));

  // earnings: sum of amounts in earnings ref (records in UGX). also render chart
  earningsRef.on('value', snap=>{
    const d = snap.val() || {};
    const items = Object.values(d);
    const total = items.reduce((acc,x)=> acc + (Number(x.amount_ugx)||0),0);
    earningsTotal.innerText = 'UGX ' + (total.toLocaleString());
    // build daily labels dataset if createdAt present
    const grouped = {};
    items.forEach(r=>{
      const dt = new Date(r.createdAt||Date.now());
      const k = dt.toISOString().slice(0,10);
      grouped[k] = (grouped[k]||0) + (Number(r.amount_ugx)||0);
    });
    const labels = Object.keys(grouped).sort();
    const dataSet = labels.map(l => grouped[l]);
    earningsChart.data.labels = labels;
    earningsChart.data.datasets[0].data = dataSet;
    earningsChart.update();
  });

  // small helper to escape HTML
  function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c])); }
  </script>
</body>
</html>
